<html>
  <head>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">

    <style>
      body {
        background: #fff; /* fallback for old browsers */
        /* background: -webkit-linear-gradient(right, #42a1f4, #8DC26F);
        background: -moz-linear-gradient(right, #42a1f4, #8DC26F);
        background: -o-linear-gradient(right, #42a1f4, #8DC26F);
        background: linear-gradient(to left, #42a1f4, #8DC26F); */
        font-family: "Roboto", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .post {
        border: 2px;
        box-sizing: border-box;
        /* border-radius: 25px; */
        background: #f2f2f2;
        margin-top: 20px;
      }

      a {
        color: blue;
      }
      .outer {
        width: 100%;
        text-align: center;
        padding: 30px;
        box-sizing: border-box;
      }
      .frame {
        max-width: 800px;
        width: 100%;
        text-align: center;
        margin: 0 auto;
      }
      .row {
        width: 100%;
        margin: 0 auto;
        text-align: left;
        /* padding: 0 15px; */
      }
      .block {
        width: 40%;
        /*float: left;*/
        margin: 0 auto;
        padding: 15 15 0 15px;
        display: inline-block;
        zoom: 1;
      }
      .post .comment {
        text-align: left;
        font-size: 200%;
        /* width:100%; */
        padding: 15px;
        margin: 0 auto;
        /* color: blue; */
      }
      .title {
        font-weight: 900;
        text-align: left;
        padding: 15px;
        font-size: 200%;
      }
      .author{
        font-family: "Roboto", sans-serif;
        text-align: left;
        padding: 0 15px;
        font-size: 120%;
      }
      .content {
        font-family: "Roboto", sans-serif;
        outline: 0;
        background: #f2f2f2;
        width: 100%;
        border: 0;
        margin: 0 auto;
        padding: 15px;
        box-sizing: border-box;
        border-radius: 25px;
        text-align: left;
        word-wrap: break-word;
        font-style: italic;
        font-size: 30px;
      }
      .nav>li>a {
        position: relative;
        display: block;
        padding: 10px 15px;
      }
      a:focus, a:hover {
        color: #23527c;
        text-decoration: underline;
      }
      .nav-tabs>li.active>a {
        color: #555;
        cursor: default;
        background-color: #fff;
        border: 1px solid #ddd;
        border-bottom-color: transparent;
        border-radius: 25px;
      }
      .comment-author {
        font-size: 50%;
      }
    </style>

    <script>
      var gPostID;
      function formateDate(date) {
        d = new Date(date)
        return d.toLocaleDateString() + ' ' + d.toLocaleTimeString()
      }
      function getCommentHtml(comment) {
        var rVal =`<br>`
        comment.sort(function(a,b) {
          return a.createdAt < b.createdAt
        });
        for (var i=0; i<comment.length; i++ ) {
            var c=comment[i]
            var date = formateDate(c.createdAt)

            rVal += `
                <div class="comment-author"> ${c.ownerName} <br> ${date}</div>
                <div class="content"><p> ${c.comment}</div>
                `
        }
        return rVal
      }
      function showCreateCommentDiag(postID) {
        gPostID = postID
        var x = document.getElementById("createCommentDialog");
        x.show();
        setInterval(function(){
          let content = document.getElementById("newComment").value;
          if ( content.length == 0) {
            $('#createCommentBtn').attr('disabled','disabled');
          } else {
            $('#createCommentBtn').removeAttr('disabled','disabled');
          }
        }, 300)

      }
      function getHtmlData(data) {

        const content = data.content
        const createdAt = data.createdAt
        const date = formateDate(createdAt)

        const id = data.id
        const author = data.ownerName
        const title = data.title
        const commentHtml = getCommentHtml(data.comment)

        const rVal =`<div class="post" id=${id}>
                      <div class="title"> <class="post" a href=#${id}> ${title} </div>
                      <hr>
                      <div class="author">${author} <br> ${date} </div>
                      <div class=content><p> ${content}</div>
                      <div class="comment">
                        <div> Comment
                        <hr>
                          ${commentHtml}
                        </div>
                        <a href="#" postID=${id} class="btn btn-primary" role="button" onclick=showCreateCommentDiag(this.attributes["postID"].value)>Add Comment</a></div>
                      </div>`

        return rVal
      }

      function showPost(data) {
        const htmlData = getHtmlData(data)
        $('#frame').append(htmlData);

      }
      function listPost(data){
        data.posts.sort(
          function(a,b) {
            return a.createdAt < b.createdAt
          }
        );
        console.info(`data.posts`, data.posts)
        for (var i = 0; i< data.posts.length; i++) {
            showPost(data.posts[i])
        }
      }

      function showCreatePostDialog() {
        var x = document.getElementById("createPostDialog");
        x.show();
        setInterval(function(){
          let title = document.getElementById("newPostTitle").value;
          let content = document.getElementById("newPostComment").value;
          console.info(`title.length == 0 || content.length == 0`, title.length == 0 || content.length == 0)
          if ( title.length == 0 || content.length == 0 ) {
            $('#createPostBtn').attr('disabled','disabled');
          } else {
            $('#createPostBtn').removeAttr('disabled','disabled');
          }
        }, 300)

      }
      function hideCreateDialog(id) {
        var x = document.getElementById(id);
        x.close();
      }

      function comment() {
        var token = localStorage.getItem('token');
        const comment = document.getElementById("newComment").value;

        $.ajax({
          url: `api/comment?postID=${gPostID}`,
          type: 'POST',
          data: JSON.stringify({ comment: comment }),
          contentType: 'application/json',
          headers: {
            "Content-Type": "application/json; charset=utf-8",
            "token":token
          },
          async:false
        }).done(function (){
          // $(location).attr('href', `/post#${gPostID}`)
          location.reload();
          window.location.href = `/post#${gPostID}`;
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
          $(location).attr('href', '/')
          return false
        });;
      }
      function logout() {
        localStorage.removeItem('token');
        $(location).attr('href', '/')
      }
      function createPost() {
        var token = localStorage.getItem('token');
        const title = document.getElementById("newPostTitle").value;
        const content = document.getElementById("newPostComment").value;

        $.ajax({
          url: 'api/post',
          type: 'POST',
          data: JSON.stringify({ title: title, content: content }),
          contentType: 'application/json',
          headers: {
            "Content-Type": "application/json; charset=utf-8",
            "token":token
          },
          async:false
        }).done(function (){
          $(location).attr('href', '/post')
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
          $(location).attr('href', '/')
          return false
        });;
      }
      $( document ).ready(function() {
        // $('#frame').append('<div class="post"><ul class="nav nav-tabs"><li role="presentation" class="active"><a href="#">Content</a></li><li role="presentation"><a href="#">Comment</a></li></ul>                  <!-- <div class="row"> --><div class="title"> Welcome! </div><div class="author">Author JM</div><div class=content><p> Content.......................................</div>                    <!-- <div class="comment"> <a onclick=clickComment()>comment </a></div> -->                    <div class="comment"><a href="#" class="btn btn-primary" role="button">Add Comment</a></div></div>');
        // $('#frame').append('<div>hello</div>');
        const token = localStorage.getItem('token');

        $.ajax({
          url: 'api/post',
          type: 'GET',
          contentType: 'application/json',
          headers: {
            "Content-Type": "application/json; charset=utf-8",
            "token":token
          },
          async:false
        }).done(listPost)
        .fail(function (jqXHR, textStatus, errorThrown) {
          $(location).attr('href', '/')
          return false
        });;
        return false;
      });
    </script>

  </head>
  <body>
        <div class="outer">
        <div class="frame" id="frame">
          <dialog id="createPostDialog">
            <div>
              Title:<br>
              <input type="text" id="newPostTitle" maxlength="16"><br>
              Content:<br>
              <input type="text" id="newPostComment" maxlength="255">
              <button href="#" class="btn btn-primary" role="button" onclick="createPost()" id="createPostBtn" disabled="disabled">Create</button>
              <a href="#" class="btn btn-primary" role="button" onclick="hideCreateDialog('createPostDialog')">Cancel</a>
            </div>
          </dialog>

          <dialog id="createCommentDialog">
            <div>
              <input type="text" id="newComment" maxlength="255">
              <button href="#" class="btn btn-primary" role="button" onclick="comment()" id="createCommentBtn" disabled="disabled">Comment</button>
              <a href="#" class="btn btn-primary" role="button" onclick="hideCreateDialog('createCommentDialog')">Cancel</a>
            </div>
          </dialog>

          <a href="#" class="btn btn-primary" role="button" onclick="showCreatePostDialog()">Create Post</a>
          <a href="#" class="btn btn-primary" role="button" onclick="logout()">Logout</a>

        </div>
      </div>
    </body>
</html>
