<html>
  <head>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">

    <style>
      body {
        background: #fff; /* fallback for old browsers */
        /* background: -webkit-linear-gradient(right, #42a1f4, #8DC26F);
        background: -moz-linear-gradient(right, #42a1f4, #8DC26F);
        background: -o-linear-gradient(right, #42a1f4, #8DC26F);
        background: linear-gradient(to left, #42a1f4, #8DC26F); */
        font-family: "Roboto", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .post {
        border: 2px;
        box-sizing: border-box;
        border-radius: 25px;
        background: #f2f2f2;
        margin-top: 20px;
      }


      .outer {
        width: 100%;
        text-align: center;
        padding: 30px;
        box-sizing: border-box;
      }
      .frame {
        max-width: 800px;
        width: 100%;
        text-align: center;
        margin: 0 auto;
      }
      .row {
        width: 100%;
        margin: 0 auto;
        text-align: right;
        /* padding: 0 15px; */
        display:inline-block;
      }
      .block {
        width: 40%;
        /*float: left;*/
        margin: 0 auto;
        padding: 15 15 0 15px;
        display: inline-block;
        zoom: 1;
      }
      .post .comment {
        text-align: left;
        font-size: 150%;
        /* width:100%; */
        padding: 15px;
        margin: 0 auto;
        /* color: blue; */

      }
      .title {
        font-family: Roboto,sans-serif;
        line-height: 1.2;
        font-weight: 400;
        text-align: left;
        padding: 15px 15px 0px 15px;
        font-size: 300%;
        /* margin: 0 0 16px; */
      }
      .comment-title {
        color: black;
      }
      .author{
        font-family: "Roboto", sans-serif;
        text-align: left;
        padding: 0 15px;
        font-size: 120%;
      }
      .content {
        font-family: "Roboto", sans-serif;
        outline: 0;
        background: #f2f2f2;
        width: 100%;
        border: 0;
        margin: 0 auto;
        padding: 15px;
        box-sizing: border-box;
        border-radius: 25px;
        text-align: left;
        word-wrap: break-word;

        font-size: 150%;
        color: #5f6368;
        line-height: 32px;
      }
      .nav>li>a {
        position: relative;
        display: block;
        padding: 10px 15px;
      }
      a:focus, a:hover {
        color: #23527c;
        text-decoration: underline;
      }
      .nav-tabs>li.active>a {
        color: #555;
        cursor: default;
        background-color: #fff;
        border: 1px solid #ddd;
        border-bottom-color: transparent;
        border-radius: 25px;
      }
      a.btn.btn-success {
        color: white;
      }
      a.no-underline {
        text-decoration: none;
        color: black;
      }
      .comment-author {
        font-size: 50%;
      }
      a.no-underline:not(.nohover):hover {
        color: black;
      }
      .post .comment p {
        font-size: 75%;
        color: #5f6368;
        /* line-height: 32px; */

      }
      .top-btn {
        margin-right: 25px;
      }
      .row .top {
        text-align: right;
      }
      dialog {
        width: 100%
        border: 2px;
        box-sizing: border-box;
        border-radius: 25px;
        background: #f2f2f2;
        /* margin-top: 20px; */
        margin: 0 auto;
        text-align: left;
        display: none;
        /* position: fixed; */
        position:absolute;
      }
      dialog input.c {
        height: 100px;
        width:100%;
        /* line-height: 1em; // this probably doesn't matter */
        /* border-radius: 25px; */
        margin-bottom: 10px;
      }
      .modal-body .input-title {
        width:100%;
        /* border-radius: 25px; */
        margin-bottom: 10px;
      }
      .modal-body {
        text-align: left;
      }
      textarea {
        width: 100%;
        margin-bottom: 10px;
        /* margin: 0 auto; */
      }

      /* The snackbar - position it at the bottom and in the middle of the screen */
      #snackbar {
          visibility: hidden; /* Hidden by default. Visible on click */
          max-width: 250px; /* Set a default minimum width */
          background-color: #f73859; /* Black background color */
          color: #fff; /* White text color */
          text-align: center; /* Centered text */
          border-radius: 2px; /* Rounded borders */
          padding: 16px; /* Padding */
          z-index: 1; /* Add a z-index if needed */
          left: 50%; /* Center the snackbar */
          bottom: 30px; /* 30px from the bottom */
          border-radius: 25px;
          width: 100%;
          margin: 15px auto;
      }

      /* Show the snackbar when clicking on a button (class added with JavaScript) */
      #snackbar.show {
          visibility: visible; /* Show the snackbar */

      /* Add animation: Take 0.5 seconds to fade in and out the snackbar.
      However, delay the fade out process for 2.5 seconds */
          -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
          animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }

      /* Animations to fade the snackbar in and out */
      @-webkit-keyframes fadein {
          from {bottom: 0; opacity: 0;}
          to {bottom: 30px; opacity: 1;}
      }

      @keyframes fadein {
          from {bottom: 0; opacity: 0;}
          to {bottom: 30px; opacity: 1;}
      }

      @-webkit-keyframes fadeout {
          from {bottom: 30px; opacity: 1;}
          to {bottom: 0; opacity: 0;}
      }

      @keyframes fadeout {
          from {bottom: 30px; opacity: 1;}
          to {bottom: 0; opacity: 0;}
      }

    </style>

    <script>
      var gPostID;
      function formateDate(date) {
        d = new Date(date)
        return d.toLocaleDateString() + ' ' + d.toLocaleTimeString()
      }
      function getCommentHtml(comment) {
        var rVal =`<br>`
        comment.sort(function(a,b) {
          return a.createdAt > b.createdAt
        });
        for (var i=0; i<comment.length; i++ ) {
            var c=comment[i]
            var date = formateDate(c.createdAt)

            rVal += `
                <div class="comment-author"> ${c.ownerName} <br> ${date}</div>
                <div class="comment"><p> ${c.comment}</div>
                `
        }
        return rVal
      }
      function showCreateCommentDiag(postID) {
        gPostID = postID
        var x = document.getElementById("createCommentDialog");

        // x.show();
        $("#createCommentDialog").css('display','block');

        setInterval(function(){
          let content = document.getElementById("newComment").value;
          if ( content.length == 0) {
            $('#createCommentBtn').attr('disabled','disabled');
          } else {
            $('#createCommentBtn').removeAttr('disabled','disabled');
          }
        }, 300)

      }
      function getHtmlData(data) {

        const content = data.content
        const createdAt = data.createdAt
        const date = formateDate(createdAt)

        const id = data.id
        const author = data.ownerName
        const title = data.title
        const commentHtml = getCommentHtml(data.comment)

        const rVal =`<div class="post" id=${id}>
                      <div class="title"> <class="post"> ${title} </div>
                      <div class="author">${author} <br> ${date} </div>
                      <div class=content><p> ${content}</div>
                      <hr>
                      <div class="comment">
                        <div class="comment-title"> Comments
                          ${commentHtml}
                        </div>
                        <div class="row" >
                          <a postID=${id} class="btn btn-success" role="button" onclick=showCreateCommentDiag(this.attributes["postID"].value)>Add Comment</a></div>
                        </div>
                      </div>`

        return rVal
      }
      function showPost(data) {
        const htmlData = getHtmlData(data)
        $('#frame').append(htmlData);

      }
      function listPost(data){
        data.posts.sort(
          function(a,b) {
            return a.createdAt < b.createdAt
          }
        );
        console.info(`data.posts`, data.posts)
        for (var i = 0; i< data.posts.length; i++) {
            showPost(data.posts[i])
        }
      }
      function showCreatePostDialog() {
        var x = document.getElementById("createPostDialog");
        // x.show();
        $("#createPostDialog").css('display','block');
        setInterval(function(){
          let title = document.getElementById("newPostTitle").value;
          let content = document.getElementById("newPostComment").value;
          console.info(`title.length == 0 || content.length == 0`, title.length == 0 || content.length == 0)
          if ( title.length == 0 || content.length == 0 ) {
            $('#createPostBtn').attr('disabled','disabled');
          } else {
            $('#createPostBtn').removeAttr('disabled','disabled');
          }
        }, 300)

      }
      function hideCreateDialog(id) {
        var x = document.getElementById(id);
        // x.close();
        $(`#${id}`).css("display","none")
      }
      function comment() {
        var token = localStorage.getItem('token');
        const comment = document.getElementById("newComment").value;

        $.ajax({
          url: `api/comment?postID=${gPostID}`,
          type: 'POST',
          data: JSON.stringify({ comment: comment }),
          contentType: 'application/json',
          headers: {
            "Content-Type": "application/json; charset=utf-8",
            "token":token
          },
          async:false
        }).done(function (){
          window.location.hash = `#${gPostID}`;
          location.reload();
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
          hideCreateDialog('createCommentDialog')
          showToast('Opps, there is something wrong...')
          return false
        });;
      }
      function logout() {
        localStorage.removeItem('token');
        $(location).attr('href', '/')
      }
      function showToast (text) {
        // Get the snackbar DIV
        var x = document.getElementById("snackbar");
        $('#snackbar').text(text);

        // Add the "show" class to DIV
        x.className = "show";
        // After 3 seconds, remove the show class from DIV
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
      }
      function createPost() {
        var token = localStorage.getItem('token');
        const title = document.getElementById("newPostTitle").value;
        const content = document.getElementById("newPostComment").value;

        $.ajax({
          url: 'api/post',
          type: 'POST',
          data: JSON.stringify({ title: title, content: content }),
          contentType: 'application/json',
          headers: {
            "Content-Type": "application/json; charset=utf-8",
            "token":token
          },
          async:false
        }).done(function (){
          $(location).attr('href', '/post')
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
          // $(location).attr('href', '/')
          hideCreateDialog('createPostDialog')
          showToast('Opps, there is something wrong...')
          return false
        });;
      }
      $( document ).ready(function() {
        const token = localStorage.getItem('token');

        $.ajax({
          url: 'api/post',
          type: 'GET',
          contentType: 'application/json',
          headers: {
            "Content-Type": "application/json; charset=utf-8",
            "token":token
          },
          async:false
        }).done(listPost)
        .fail(function (jqXHR, textStatus, errorThrown) {
          $(location).attr('href', '/')
          return false
        });;
        return false;
      });
    </script>

  </head>
  <body>
        <div class="outer">
        <div class="frame" id="frame">

          <!-- Modal -->
         <div class="modal"  id="createPostDialog" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
           <div class="modal-dialog" role="document">
             <div class="modal-content">
               <div class="modal-header">
                 <h5 class="modal-title">New Post</h5>
                 <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                   <span aria-hidden="true" onclick="hideCreateDialog('createPostDialog')">&times;</span>
                 </button>
               </div>
               <div class="modal-body">
                 <div>
                   Title:<br>
                   <input class="input-title" type="text" id="newPostTitle" maxlength="16"></textarea><br>
                   Content:<br>
                   <textarea rows="4" class="c" id="newPostComment" maxlength="255"></textarea>
                </div>
               </div>
               <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="hideCreateDialog('createPostDialog')" >Close</button>
                 <button type="button" class="btn btn-primary" onclick="createPost()" id="createPostBtn"> Post</button>
               </div>
             </div>
           </div>
         </div>

         <div class="modal"  id="createCommentDialog" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
           <div class="modal-dialog" role="document">
             <div class="modal-content">
               <div class="modal-header">
                 <h5 class="modal-title">Comment</h5>
                 <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                   <span aria-hidden="true" onclick="hideCreateDialog('createCommentDialog')">&times;</span>
                 </button>
               </div>
               <div class="modal-body">
                 <div>
                   <textarea rows="4" class="c" type="text" id="newComment" maxlength="255"></textarea>
                </div>
               </div>
               <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="hideCreateDialog('createCommentDialog')" >Close</button>
                 <button type="button" class="btn btn-primary" onclick="comment()" id="createCommentBtn">Comment</button>
               </div>
             </div>
           </div>
         </div>

          <div class="row top">
            <a class="btn btn-success top-btn" role="button" onclick="showCreatePostDialog()">Create Post</a>
            <a class="btn btn-success top-btn" role="button" onclick="logout()">Logout</a>
          </div>
          <div id="snackbar">Opps, there is something wrong...</div>
        </div>
      </div>
    </body>
</html>
